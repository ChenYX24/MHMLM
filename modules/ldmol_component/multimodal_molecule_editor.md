# Multimodal Molecule Editor

基于 LDMol 和 GVP 的多模态分子编辑架构。

## 任务定义

```
输入: source_smiles + edit_instruction
输出: target_smiles (优化后的分子)
```

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              Multimodal Molecule Editor                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              INPUT PROCESSING                                             │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                  │
│      source_smiles                                    edit_instruction                           │
│           │                                                  │                                   │
│           ▼                                                  ▼                                   │
│   ┌───────────────┐                               ┌────────────────────┐                        │
│   │   RDKit 3D    │                               │   Tokenizer        │                        │
│   │   Embedding   │                               │   (Qwen3)          │                        │
│   └───────┬───────┘                               └──────────┬─────────┘                        │
│           │                                                  │                                   │
│           ▼                                                  ▼                                   │
│   ┌───────────────────────┐                       ┌────────────────────────────┐                │
│   │        GVP            │                       │      Text Encoder          │                │
│   │  ┌─────────────────┐  │                       │  ┌──────────────────────┐  │                │
│   │  │ Node: atoms     │  │                       │  │  Qwen3-8B (frozen)   │  │                │
│   │  │ Edge: bonds     │  │                       │  │                      │  │                │
│   │  │ Coord: 3D pos   │  │                       │  │  hidden_size: 4096   │  │                │
│   │  └─────────────────┘  │                       │  └──────────────────────┘  │                │
│   │                       │                       │                            │                │
│   │  output_dim: 256      │                       │  output: [B, L, 4096]      │                │
│   │  (frozen)             │                       │  (frozen)                  │                │
│   └───────────┬───────────┘                       └─────────────┬──────────────┘                │
│               │                                                 │                                │
│               │ [B, 256]                                        │ [B, L, 4096]                   │
│               │                                                 │                                │
│   ┌───────────┴─────────────────────────────────────────────────┴───────────┐                   │
│   │                                                                          │                   │
│   │                      CONDITION FUSION MODULE (trainable)                 │                   │
│   │   ┌────────────────────────────────────────────────────────────────┐    │                   │
│   │   │                                                                │    │                   │
│   │   │   GVP [B, 256] ──→ Linear(256, 1152) ──→ [B, 1, 1152]         │    │                   │
│   │   │                                              │                 │    │                   │
│   │   │                                              │ concat          │    │                   │
│   │   │                                              ▼                 │    │                   │
│   │   │   Text [B, L, 4096] ──→ Linear(4096, 1152) ──→ [B, L, 1152]   │    │                   │
│   │   │                                              │                 │    │                   │
│   │   │                                              ▼                 │    │                   │
│   │   │                                     [B, L+1, 1152] ───────────────────→ y_cond         │
│   │   │                                                                │    │                   │
│   │   └────────────────────────────────────────────────────────────────┘    │                   │
│   │                                                                          │                   │
│   └──────────────────────────────────────────────────────────────────────────┘                   │
│                                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              DIFFUSION PROCESS                                            │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                  │
│                    y_cond [B, L+1, 1152]                                                         │
│                              │                                                                   │
│                              ▼                                                                   │
│   x_T ──────────→ ┌─────────────────────────────────┐                                           │
│   [B, 64, 127, 1] │           DiT                   │                                           │
│   (random noise)  │  ┌───────────────────────────┐  │                                           │
│                   │  │  Transformer Blocks (28)  │  │                                           │
│                   │  │  - Self-Attention         │  │                                           │
│                   │  │  - Cross-Attention ← cond │  │                                           │
│                   │  │  - MLP                    │  │                                           │
│                   │  │                           │  │                                           │
│                   │  │  LoRA fine-tune (rank=8)  │  │                                           │
│                   │  └───────────────────────────┘  │                                           │
│                   │                                 │                                           │
│                   │  DDPM Sampling (50 steps)       │                                           │
│                   └────────────────┬────────────────┘                                           │
│                                    │                                                             │
│                                    ▼                                                             │
│                              x_0 [B, 64, 127, 1]                                                 │
│                              (denoised latent)                                                   │
│                                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              DECODING                                                     │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                  │
│                              x_0 [B, 64, 127, 1]                                                 │
│                                    │                                                             │
│                                    ▼                                                             │
│                   ┌─────────────────────────────────┐                                           │
│                   │       AE Decoder (frozen)       │                                           │
│                   │  ┌───────────────────────────┐  │                                           │
│                   │  │  reshape → [B, 127, 64]   │  │                                           │
│                   │  │  decode_prefix(64→1024)   │  │                                           │
│                   │  │  BERT Decoder             │  │                                           │
│                   │  │  vocab_size: 300          │  │                                           │
│                   │  └───────────────────────────┘  │                                           │
│                   └────────────────┬────────────────┘                                           │
│                                    │                                                             │
│                                    ▼                                                             │
│                             target_smiles                                                        │
│                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 训练数据流

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              TRAINING DATAFLOW                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   train_mol_edit.jsonl                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │ {                                                                            │   │
│   │   "source_smiles": "CCCc1c(OC)nc2nc(C(=O)c3ccc(Cl)cc3)cn2c1CC",             │   │
│   │   "edit_instruction": "Optimize ... to reduce high DILI risk ...",           │   │
│   │   "target_smiles": "CCCc1c(OC)nc2nc(C(=O)c3ccccc3)cn2c1CC",                  │   │
│   │   "template": "natural_language"                                             │   │
│   │ }                                                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│         │                        │                         │                         │
│         ▼                        ▼                         ▼                         │
│   ┌───────────┐           ┌────────────┐           ┌─────────────┐                  │
│   │    GVP    │           │   Qwen3    │           │  AE Encoder │                  │
│   └─────┬─────┘           └──────┬─────┘           └──────┬──────┘                  │
│         │                        │                        │                          │
│         ▼                        ▼                        ▼                          │
│   gvp_emb [B,256]         text_emb [B,L,4096]       x_0 [B,64,127,1]                │
│         │                        │                        │                          │
│         └────────────┬───────────┘                        │                          │
│                      ▼                                    │                          │
│                  Fusion                                   │                          │
│                      │                                    │                          │
│                      ▼                                    │                          │
│              y_cond [B,L+1,1152]                          │                          │
│                      │                                    │                          │
│                      └──────────────────┬─────────────────┘                          │
│                                         │                                            │
│                                         ▼                                            │
│                                    ┌─────────┐                                       │
│                                    │   DiT   │                                       │
│                                    │ Denoise │                                       │
│                                    └────┬────┘                                       │
│                                         │                                            │
│                                         ▼                                            │
│                                    L_diffusion                                       │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 组件说明

| 组件 | 来源 | 状态 | 输入 | 输出 |
|------|------|------|------|------|
| **GVP** | 预训练 | frozen | source_smiles → 3D graph | `[B, 256]` |
| **Text Encoder** | Qwen3-8B | frozen | edit_instruction | `[B, L, 4096]` |
| **Condition Fusion** | 新增 | trainable | GVP emb + Text emb | `[B, L', hidden]` |
| **DiT** | LDMol | fine-tune (LoRA) | x_t + y_cond | x_0 |
| **AE Decoder** | LDMol | frozen | latent | SMILES |

## Condition Fusion Module

融合 GVP 结构特征和 Text 编辑指令：

```
GVP: [B, 256]  ──── proj ────→ [B, 1, hidden]  ─┐
                                                 ├──→ concat ──→ [B, L+1, hidden]
Text: [B, L, 4096] ─ proj ───→ [B, L, hidden]  ─┘
```

## 训练策略

**冻结**：GVP, Text Encoder, AE Encoder/Decoder  
**微调**：DiT (LoRA), Condition Fusion Module

**损失函数**：
```
L = L_diffusion(x_0, x̂_0) + λ · L_recon(target_smiles, decoded_smiles)
```

## 训练数据

| 模板 | 占比 | 用途 |
|------|------|------|
| `full_context` | ~77% | 完整 instruction + ADMET profile |
| `natural_language` | ~14% | 简洁自然语言指令 |
| `reasoning_guided` | ~9% | 化学修改策略 |

数据路径：`eval_results/data/ldmol/drug_optim/processed/train_mol_edit.jsonl`

## 推理流程

```python
# 1. 编码条件
gvp_emb = gvp_encoder(source_smiles)           # [B, 256]
text_emb = text_encoder(edit_instruction)       # [B, L, 4096]
y_cond = fusion_module(gvp_emb, text_emb)       # [B, L', hidden]

# 2. 扩散采样
x_T = torch.randn(B, C, 127, 1)
x_0 = dit.sample(x_T, y_cond, steps=50)

# 3. 解码
target_smiles = ae_decoder(x_0)
```

## 文件结构

```
modules/ldmol_component/
├── multimodal_molecule_editor.md   # 本文档
├── molecule_editor.py              # MoleculeEditor 类（待实现）
├── condition_fusion.py             # ConditionFusionModule（待实现）
└── LDMolTrainer.py                 # 训练入口（已有，需扩展）
```
