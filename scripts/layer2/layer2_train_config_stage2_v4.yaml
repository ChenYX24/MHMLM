# Layer2 Stage 2 训练配置 (v4 - Partial Unfreeze + Multi-Regularization)
#
# Strategy: Unfreeze top 2 encoder layers (6,7) + differential LR + EMA + early stop
# Expected: ~15M trainable (26%), balance adaptation vs memorization
#
# Changes from v3 (frozen backbone):
# - unfreeze_top_layers: 2 (top encoder layers trainable)
# - backbone_lr: 3e-5 (gentle backbone fine-tuning)
# - head_lr: 1e-3 (fast head learning)
# - head_dropout: 0.3 (regularize before heads)
# - yield_label_smoothing: 0.1 (softer CE targets)
# - ema_decay: 0.999 (shadow weight averaging)
# - patience: 20 (early stopping)
# - weight_decay: 0.05 (stronger regularization)

# 模型配置 (must match Stage 1 checkpoint)
mol_emb_dim: 256
hidden_dim: 768
n_layers: 8
n_heads: 12
dropout: 0.2
num_roles: 11
num_token_types: 2
tau: 0.07
learnable_tau: true
symmetric_ince: true
use_projection_head: true

# v4: Head dropout before task heads
head_dropout: 0.3

# 数据配置
data_path: "/data1/chenyuxuan/Layer2/data/ord_layer2_v2/layer2_train.jsonl"
val_data_path: "/data1/chenyuxuan/Layer2/data/ord_layer2_v2/layer2_val.jsonl"
use_indexed_dataset: true

# 训练配置
batch_size: 64
weight_decay: 0.05
num_epochs: 300
warmup_steps: 500
min_lr: 0.000001
grad_accumulation_steps: 2
save_steps: 600
eval_steps: 300
log_steps: 50
num_workers: 4

# Freeze strategy: partial unfreeze
freeze_backbone: true
unfreeze_top_layers: 2

# Differential LR
backbone_lr: 0.00003
head_lr: 0.001

# AMP
use_amp: true

# Loss 权重
emb_lambda: 1.0
amt_lambda: 0.3
yield_weight: 3.0
yield_mode: "both"
yield_soft_bin_temperature: 0.1
yield_reg_lambda: 1.0
yield_class_weights: true

# v4: Label smoothing for yield classification
yield_label_smoothing: 0.1

# v4: EMA for smoother generalization
ema_decay: 0.999

# v4: Early stopping (in eval steps)
patience: 20

# Masking (yield-focused, 50%)
p_forward: 0.20
p_retro: 0.15
p_condition: 0.10
p_random: 0.05
p_yield_full: 0.25
p_yield_with_product: 0.25

# Resume from Stage 1
resume_from: "/data1/chenyuxuan/Layer2/ckpt/0115/layer2_pretrain.pt"

# 其他
tf32: true
global_seed: 42
results_dir: "/data1/chenyuxuan/checkpoint/layer2_stage2"
